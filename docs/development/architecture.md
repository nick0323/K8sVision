# K8sVision 项目架构

本文档详细介绍了 K8sVision 项目的技术架构、代码组织和设计模式。

## 🏗️ 整体架构

### 架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (React)   │    │   后端 (Go)     │    │  Kubernetes     │
│                 │    │                 │    │   集群          │
│  - Ant Design   │◄──►│  - Gin          │◄──►│  - API Server   │
│  - Redux        │    │  - JWT Auth     │    │  - etcd         │
│  - Axios        │    │  - Swagger      │    │  - Controller   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                       ┌─────────────────┐
                       │   缓存层        │
                       │                 │
                       │  - 内存缓存     │
                       │  - Redis (可选) │
                       └─────────────────┘
```

### 技术栈
- **前端**: React + Ant Design + Redux Toolkit
- **后端**: Go + Gin + JWT + Swagger
- **容器化**: Docker + Docker Compose
- **部署**: Kubernetes + Helm
- **监控**: 内置指标收集 + Prometheus (计划)

## 📁 代码结构

### 后端结构
```
K8sVision/
├── api/                    # API 层 - 路由和处理器
│   ├── middleware/         # 中间件
│   │   ├── auth.go        # JWT 认证
│   │   ├── error.go       # 错误处理
│   │   └── metrics.go     # 性能监控
│   ├── common.go          # 通用处理函数
│   ├── login.go           # 登录接口
│   ├── node.go            # 节点相关 API
│   ├── pod.go             # Pod 相关 API
│   └── ...                # 其他资源 API
├── service/               # 业务逻辑层
│   ├── k8s.go            # Kubernetes 客户端管理
│   ├── common.go         # 通用业务逻辑
│   ├── overview.go       # 集群概览
│   ├── node.go           # 节点业务逻辑
│   ├── pod.go            # Pod 业务逻辑
│   └── ...               # 其他资源业务逻辑
├── model/                 # 数据模型层
│   ├── types.go          # 数据结构定义
│   ├── consts.go         # 常量定义
│   └── config.go         # 配置结构
├── config/               # 配置管理
│   └── manager.go        # 配置管理器
├── cache/                # 缓存层
│   └── manager.go        # 缓存管理器
├── monitor/              # 监控层
│   └── metrics.go        # 性能指标收集
├── docs/                 # Swagger 文档
├── main.go               # 应用入口
├── go.mod                # Go 模块文件
├── go.sum                # 依赖校验
├── config.yaml           # 配置文件
├── Dockerfile            # 容器构建文件
└── docker-compose.yml    # 本地开发环境
```

### 前端结构
```
frontend/
├── src/
│   ├── components/       # 通用组件
│   ├── pages/           # 页面组件
│   ├── services/        # API 服务
│   ├── store/           # Redux 状态管理
│   ├── utils/           # 工具函数
│   └── App.tsx          # 应用入口
├── public/              # 静态资源
├── package.json         # 依赖配置
└── vite.config.ts       # 构建配置
```

## 🔄 数据流

### 请求处理流程
```
1. 客户端请求 → 2. 中间件处理 → 3. 路由分发 → 4. 业务逻辑 → 5. 数据访问 → 6. 响应返回
```

### 详细流程
1. **请求接收**: Gin 框架接收 HTTP 请求
2. **中间件处理**: 
   - 错误处理中间件
   - 请求追踪中间件
   - 日志记录中间件
   - 性能监控中间件
   - JWT 认证中间件（受保护的路由）
3. **路由分发**: 根据 URL 路径分发到对应的处理器
4. **业务逻辑**: 在 service 层处理业务逻辑
5. **数据访问**: 通过 Kubernetes 客户端访问集群数据
6. **缓存处理**: 查询缓存，必要时更新缓存
7. **响应返回**: 格式化响应数据并返回

## 🧩 核心模块

### 1. API 层 (api/)
**职责**: 处理 HTTP 请求，参数验证，响应格式化

**设计模式**: 
- 依赖注入模式
- 中间件模式
- 装饰器模式

**关键组件**:
- `middleware/`: 中间件集合
- `common.go`: 通用处理函数
- 各资源 API 文件

### 2. 业务逻辑层 (service/)
**职责**: 实现业务逻辑，数据处理，缓存管理

**设计模式**:
- 服务层模式
- 工厂模式
- 策略模式

**关键组件**:
- `k8s.go`: Kubernetes 客户端管理
- `common.go`: 通用业务逻辑
- 各资源业务逻辑文件

### 3. 数据模型层 (model/)
**职责**: 定义数据结构，常量，配置

**设计模式**:
- 数据传输对象 (DTO)
- 配置模式

**关键组件**:
- `types.go`: 数据结构定义
- `consts.go`: 常量定义
- `config.go`: 配置结构

### 4. 配置管理 (config/)
**职责**: 配置加载，环境变量处理，配置热重载

**设计模式**:
- 单例模式
- 观察者模式

**关键组件**:
- `manager.go`: 配置管理器

### 5. 缓存层 (cache/)
**职责**: 数据缓存，性能优化

**设计模式**:
- 缓存模式
- 策略模式

**关键组件**:
- `manager.go`: 缓存管理器

### 6. 监控层 (monitor/)
**职责**: 性能监控，指标收集

**设计模式**:
- 观察者模式
- 单例模式

**关键组件**:
- `metrics.go`: 性能指标收集

## 🔐 安全架构

### 认证机制
- **JWT Token**: 基于 JWT 的无状态认证
- **Token 过期**: 24 小时自动过期
- **防爆破**: 登录失败次数限制

### 权限控制
- **中间件**: JWT 认证中间件
- **权限检查**: 基于角色的权限控制（待完善）
- **资源隔离**: 命名空间级别的资源隔离

### 安全特性
- **HTTPS**: 支持 HTTPS 传输
- **CORS**: 跨域资源共享配置
- **输入验证**: 参数验证和过滤
- **错误处理**: 安全的错误信息处理

## 📊 性能优化

### 缓存策略
- **内存缓存**: 默认使用内存缓存
- **TTL 机制**: 缓存自动过期
- **缓存预热**: 启动时预加载数据
- **缓存穿透保护**: 防止缓存穿透攻击

### 并发处理
- **Goroutine**: 使用 Go 协程处理并发
- **连接池**: Kubernetes 客户端连接池
- **限流**: API 访问频率限制

### 监控指标
- **请求统计**: 总请求数、成功数、失败数
- **响应时间**: 最小、最大、平均响应时间
- **缓存统计**: 缓存命中率
- **连接统计**: 当前连接数、最大连接数

## 🔄 部署架构

### 本地开发
```
┌─────────────────┐    ┌─────────────────┐
│   Docker Compose│    │   Kubernetes    │
│                 │    │   集群          │
│  - 前端容器     │    │  - API Server   │
│  - 后端容器     │◄──►│  - etcd         │
│  - Nginx 容器   │    │  - Controller   │
└─────────────────┘    └─────────────────┘
```

### 生产环境
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   负载均衡器    │    │   Kubernetes    │    │   监控系统      │
│                 │    │   集群          │    │                 │
│  - Nginx        │◄──►│  - K8sVision    │◄──►│  - Prometheus   │
│  - Ingress      │    │  - API Server   │    │  - Grafana      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 🧪 测试架构

### 测试层次
- **单元测试**: 业务逻辑测试
- **集成测试**: API 接口测试
- **端到端测试**: 完整流程测试

### 测试工具
- **Go 测试**: 内置测试框架
- **Testify**: 测试辅助库
- **HTTP 测试**: API 测试

## 📈 扩展性设计

### 模块化设计
- **插件化**: 支持功能插件扩展
- **配置化**: 通过配置控制功能
- **接口化**: 定义清晰的接口

### 水平扩展
- **无状态**: 后端服务无状态设计
- **负载均衡**: 支持多实例部署
- **缓存共享**: 支持分布式缓存

### 垂直扩展
- **资源限制**: 容器资源限制
- **性能调优**: 参数调优
- **监控告警**: 性能监控和告警

## 🔮 未来规划

### 短期目标
- [ ] 完善权限系统
- [ ] 集成数据库
- [ ] 添加 Prometheus 监控
- [ ] 完善测试覆盖

### 长期目标
- [ ] 多集群管理
- [ ] 工作流引擎
- [ ] 通知系统
- [ ] 高级监控功能

## 📚 相关文档

- [开发环境搭建](./setup.md)
- [API 开发指南](./api-guide.md)
- [前端开发指南](./frontend-guide.md)
- [部署指南](../deployment/README.md)
- [配置说明](../configuration.md)

---

**架构版本**: v1.0.0  
**最后更新**: 2024年12月 